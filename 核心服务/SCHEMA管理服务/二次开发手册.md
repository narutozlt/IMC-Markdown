<h1 align="center" style="margin: 30px 0 30px; font-weight: bold;">SCHEMA二次开发手册</h1>
<h4 align="center">基于 Vue/Element UI 和 Spring Boot/Spring Cloud & Alibaba 前后端分离的分布式微服务架构</h4>
<p align="center">
    <a href="http://imc.smartsolutions.com.cn/login"></a>
    <a href="http://imc.smartsolutions.com.cn/login"><img src="https://img.shields.io/badge/IMC-v3.5.0-brightgreen.svg"></a>	
</p>



## 目录


* [Schema介绍](#2)
  * [Schema概念介绍](#3)
  * [Schema配置介绍](#4)
    * [类定义](#5)
    * [接口定义](#6)
    * [属性定义](#7)
    
      * [枚举列表](#8)
    
    * [关联定义](#9)
  * [Excel操作schema介绍](#10)

    * [新增条目](#11)
    * [导出为xml](#12)
    * [导入到IMC](#13)
  * [Schema操作代码示例](#14)

<a id = "2"></a>

## Schema介绍

<a id = "3"></a>

### schema概念介绍

数据模型是定义可以在数据库中存储哪些信息以及对象之间可以具有哪些关系的结构。 例如，数据模型定义了哪些属性可以定义标签。 它还描述了文档与其他对象之间的关系。

schema由许多组件组成，这些组件一起工作来定义您的数据，
 包括：

- **类定义** - 对一组扮演类似角色并共享一些相同属性和关系的对象的命名描述。

  例如，作为组织实例的对象可以扮演以下角色中的一个或多个：内部组织、外部组织、供应商、制造商或承包商。

- **接口定义** - 对象可用的属性集合，作为一个整体，代表对象所扮演的角色。 接口定义也是关联关系定义的端点。

  每个角色都由不同的接口定义表示，接口定义暴露特定于该角色的属性同时拥有特定于该角色的关联关系。

- **关联关系定义** - 对象如何相互关联的定义，通过接口互相连接。

  例如，关系定义描述了组织和合同之间可能存在的关系。 关系定义可以包括诸如每个合同可以与多少个组织相关以及删除合同时组织会发生什么等信息。

- **属性定义** - 描述对象的属性。 属性通过接口定义与类定义相关。

- **枚举定义** - 描述了一系列枚举对象的属性

<a id = "4"></a>

### schema配置介绍

<a id = "5"></a>

#### 类定义

**类定义属性**

| 属性               | 描述                   |
| ------------------ | ---------------------- |
| name               | 类的名称               |
| description        | 类的描述               |
| displayName        | 展示名称               |
| isConfigControlled | 表示该类是否受配置控制 |
| uidPattern         |                        |
| rev                |                        |
| ver                |                        |
| containerId        | 所属的container        |
| tableName          | 表名                   |
| cachedInfo         | 缓存信息               |
| isActivated        |                        |

**类定义和接口定义**

类定义提供了软件可以与之交互的不同角色。 类定义通过称为接口定义的抽象实体来公开或实现其角色。

类定义与接口定义具有实现关系，即存在Realizes关系。 这意味着特定类定义的实例支持或实现那些已实现的接口定义。

![SHARED Tip](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAANCAIAAAC7P9CBAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTExIDc5LjE1ODMyNSwgMjAxNS8wOS8xMC0wMToxMDoyMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkMmJjM2E2OS00YTUyLTdlNDgtODFkYS05ZDFhOTA0N2U3NTIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDMwMUM5MDgyREM4MTFFNjk3NzY4MjA2NEMwMDc1NzciIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDMwMUM5MDcyREM4MTFFNjk3NzY4MjA2NEMwMDc1NzciIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6ODdhMTM4MzYtMjc5MC03YTRiLThmODktODI2NTIxNjQ3N2M4IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOmQyYmMzYTY5LTRhNTItN2U0OC04MWRhLTlkMWE5MDQ3ZTc1MiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PoAZ1o0AAAEjSURBVHjaYvz//z/DAAEWOOvjL4bKswwzb4LY6eoM7cYM/GwoShmrj+Mx6H+rJVwNhI1Vy+xA5RQTMQibCUL9/c8gtIxh+g2Gf/9BCMgAcv/SIERS19/devM9ir93PgVZiQyAXKCglwy6z5A9hCyCBxxK1bZV4AMy7GdfPfTgk8+iGxCNUH/HHETXIMiGRZA8wMvODGEcTNUGWcnIgBLmmOD9L5qnNajdZ/wwEiETFkEKgUb/BUhsosS3Ei/DLGuGtKMwFzEyTLMECVIFGE65BGezszDtSdJCz2OpaiBEazDFV9FGnhfdbiBYepchGez1udYM0cpUs+98jp6BJDe+sgUIgPZR0Upi0xrc3xyLQAjIoGuZCgSWYgxJqlAGHQBAgAEAhy9Y5GqbRX4AAAAASUVORK5CYII=) 使用 Rel关系上的 IsRequired 标志来指定特定类定义的对象的接口定义是必须的或者是可选的。

![](./img/class_realize_interface.png)

如图，类CIMWorkflow实现了5个基本接口，分别是IObject、IObjectEx、ICIMConditionComposition、ICIMWorkflow、ICIMWorkflowObject

<a id = "6"></a>

#### 接口定义

**接口定义属性**

| 属性                    | 描述            |
| ----------------------- | --------------- |
| name                    | 接口名称        |
| description             | 接口描述        |
| displayName             | 展示名称        |
| isActivated             |                 |
| rev                     |                 |
| ver                     |                 |
| interfaceSequenceNumber | 接口序列号      |
| containerId             | 所属的container |

**作为角色的接口定义**

接口定义代表了类定义的角色。 角色定义了对象的属性和关系。 一些接口被定义为携带属性，一些被定义为携带关联关系， 其他的可能仅仅被定义为指示角色。

不同的类定义可以共享相同的接口定义，因此具有相同的角色。 例如：CIMWorkflow和CIMWorkflowTemplate共享IObject接口，这意味着CIMWorkflow和CIMWorkflowTemplate都具有object的角色，它们都具有object name、object description、object identifier以及 IObject 接口公开的任何其他属性定义。

**继承关系**

如果一个接口定义继承了另一个接口定义，即两个接口定义之间存在 Implies 关系，那么任何实现第一个接口定义的类定义也可以实现被继承的接口定义。

![](img/interface_inheritance.png)

如图，ICIMWorkflow继承了IObject，ICIMWorkflowObject和ICIMWorkflowTemplate继承了ICIMWorkflow。 因此，任何实现 ICIMWorkflowObject和ICIMWorkflowTemplate的类定义（例如 CIMWorkflowTemplate）也可以实现IObject和ICIMWorkflow。 

<a id = "7"></a>

#### 属性定义

对象的所有属性定义都是通过其接口定义公开的，而不是直接由对象公开。 应用于特定接口定义的属性定义是由模式中 InterfaceDef 类型的对象和 PropertyDef 类型的对象之间的 Expose 关系定义的。 给定类定义的特定属性定义通常由一个且仅一个接口定义公开。

![](./img/property.png)

如上图所示，ICIMWorkflowStepLegend接口定义公开了几个属性定义，包括：

- WorkflowStepLegendTextColor - 步骤图例的文字颜色
- WorkflowStepLegendIcon - 步骤图例的图标
- WorkflowStepLegendTitle - 步骤图例的标题
- WorkflowStepLegendBackgroundColor - 步骤图例的背景色

通过且仅能通过ICIMWorkflowStepLegend接口来配置这些属性

<a id = "8"></a>

##### 枚举列表

在schema中，某些属性定义是枚举列表类型（EnumListType）。 这些属性定义在枚举列表（有时称为“选择列表”或“查找”）中为其定义了可能的字符串属性值列表。 此类型的属性定义的任何值都必须与为该属性类型定义的枚举属性值列表中的条目匹配。

每个枚举列表包含一个或多个枚举条目（EnumEnum）。 每个枚举条目代表该枚举列表范围内的属性的可能值。

![](./img/enumlist.png)

如上图所示，WorkflowStatus有4个枚举值，分别为Working、Processed、Completed、Error

<a id = "9"></a>

#### 关联定义

**关联定义属性**

| 属性                                | 描述                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| name                                | 关联名称                                                     |
| description                         | 关联描述                                                     |
| displayName                         | 展示名称                                                     |
| isActivated                         |                                                              |
| tableName                           | 表名                                                         |
| cachedInfo                          | 缓存信息                                                     |
| interfaceDefUid1 & interfaceDefUid2 | 关联接口的uid                                                |
| min1 & min2                         | 这两个属性决定是否需要关系。 值 0 表示关系是可选的，而值 1 表示关系是必需的。<br>配置为 Min1=1 和 Min2=0 意味着则末端 2 处的对象不能脱离于该关联关系存在，因为它必须对应末端 1 处的至少一个对象。 |
| max1 & max2                         | 这两个属性用于标识可以参与关系每一端的对象的最大数量。 最常见的值为 1 或 *。<br>Max2=1的关系意味着1端的对象只能与2端的单个对象相关。<br>Max1=1的关系意味着2端的对象只能与1端的一个对象相关。 |
| displayName1 & displayName2         | 展示名                                                       |
| optionalInterfaces                  |                                                              |
| rev                                 |                                                              |
| ver                                 |                                                              |
| delete1To2 & delete2To1             | 这两个属性用于控制删除关系两端的对象时发生的情况。删除一端对象时，与该对象的所有关联对象也将被删除<br>将Delete12设置为True表示当删除1端的对象时，2端的对象也必须被删除。 |

关联定义表示了两个接口之间的关联关系

 ![](./img/rel.png)

如上图，在 WorkflowTemplateNotificationType 关联关系中，将ICIMWorkflowTemplate与ICIMWorkflowNotificationType进行了一个多对一的关联(0..*)--(0..1)，即让一个工作流模板对应一个工作流提醒类型、一个工作流提醒类型可对应多个工作流模板。

<a id = "10"></a>

### Excel操作schema介绍

<a id = "11"></a>

#### 新增条目

![](./img/insert.png)

在需要新增的地方右键，点击`Insert`插入空白行，填写属性对应值即可

<a id = "12"></a>

#### 导出为xml

![](./img/xml.png)

在README界面点击箭头所指按钮，自动在文件根目录下生成包含xml文件的文件夹，文件目录结构如下：

```
|--SCHEMA_IMC_WF
|  |--01_接口_CIM.xml
|  |--02_枚举_CIM.xml
|  |--03_属性_CIM.xml
|  |--...
|  |--19_流程分类_CIM.xml
|  |--SCHEMA_IMC_WF_CIM.xmlldr
|--SCHEMA_IMC_WF.xlsm
```

<a id = "13"></a>

#### 导入到IMC



<a id = "14"></a>

### Schema操作代码示例

#### 创建操作代码示例

- 1.创建新对象 

  ```java
  ObjectCollection objectCollection = new ObjectCollection(GeneralUtil.getUsername());
  IObject object = SchemaUtil.newIObject("ClassDefUID", "name", "description", "displayName");
  ```

  - 1.1 属性值填充

    - 1.1.1 属性填充方法1 通过 接口UID 属性UID 属性值 的Map进行属性填充

      ```java
      Map<String, Map<String, String>> interfaceProperties = new HashMap<String, Map<String, String>>();
              Map<String, String> properties = new HashMap<>();
              properties.put("propertyUID1", "value");
              properties.put("propertyUID2", "value");
              properties.put("propertyUID3", "value");
              interfaceProperties.put("InterfaceDefUID", properties);
              object.setProperties(interfaceProperties);
      ```

    - 1.1.2 属性填充方法2 转换为对应接口填充对应接口绑定的属性 IObject只是演示用才作为toInterface的class,实际需要替换为正确的class

      ```java
       IObject interfaceObj = object.toInterface(IObject.class);
       interfaceObj.setName("value");
       interfaceObj.setDescription("value");
      ```

    - 1.1.3 属性填充方法3 new Object()为演示中替代具体值的示例,实际值是Object类型的对象

      ```java
       // 推荐
       object.setValue("InterfaceDefUID", "propertyUID", new Object(), null);
       // 不推荐
       object.setValue(null, "propertyUID", new Object(), null);
      ```

  - 1.2 创建完对象后必须标记创建结束,否则提交事务时无法成功写入数据

    ```java
    object.finishCreate(objectCollection);
    ```

- 2.创建新关联关系 end1和end2可以为新创建的对象或者查询出的对象

  ```java
   IObject end1 = SchemaUtil.newIObject("ClassDefUID", "end1", "description", "displayName");
   end1.finishCreate(objectCollection);
   IObject end2 = SchemaUtil.newIObject("ClassDefUID", "end2", "description", "displayName");
   end2.finishCreate(objectCollection);
  ```

  - 2.1 单个关联关系创建

    ```java
    IRel relationship = SchemaUtil.newRelationship("RelDefUID", end1, end2);
    ```

  - 2.2 创建完关联关系对象后必须标记创建结束,否则提交事务时无法成功写入数据

    ```java
    relationship.finishCreate(objectCollection);
    ```

  - 批量关联关系创建

    ```java
    SchemaUtil.createRelationships1To2("RelDefUID", end1, objectCollection, new ArrayList<>());
    ```

#### 更新操作代码示例

- 更新 更新需要先查询出对应数据再进行操作

  ```java
  IObject toDelete = Context.Instance.getQueryHelper().getObjectByUidAndDefinitionUid("UID", "ClassDefUID", IObject.class);
  // 物理删除 内置直接提交事务
  toDelete.Delete();
  // 物理删除 手动控制提交事务
  toDelete.Delete(objectCollection);
  // 逻辑删除
  toDelete.Terminate(objectCollection);
  ```

![SHARED Tip](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAANCAIAAAC7P9CBAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTExIDc5LjE1ODMyNSwgMjAxNS8wOS8xMC0wMToxMDoyMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkMmJjM2E2OS00YTUyLTdlNDgtODFkYS05ZDFhOTA0N2U3NTIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDMwMUM5MDgyREM4MTFFNjk3NzY4MjA2NEMwMDc1NzciIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDMwMUM5MDcyREM4MTFFNjk3NzY4MjA2NEMwMDc1NzciIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6ODdhMTM4MzYtMjc5MC03YTRiLThmODktODI2NTIxNjQ3N2M4IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOmQyYmMzYTY5LTRhNTItN2U0OC04MWRhLTlkMWE5MDQ3ZTc1MiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PoAZ1o0AAAEjSURBVHjaYvz//z/DAAEWOOvjL4bKswwzb4LY6eoM7cYM/GwoShmrj+Mx6H+rJVwNhI1Vy+xA5RQTMQibCUL9/c8gtIxh+g2Gf/9BCMgAcv/SIERS19/devM9ir93PgVZiQyAXKCglwy6z5A9hCyCBxxK1bZV4AMy7GdfPfTgk8+iGxCNUH/HHETXIMiGRZA8wMvODGEcTNUGWcnIgBLmmOD9L5qnNajdZ/wwEiETFkEKgUb/BUhsosS3Ei/DLGuGtKMwFzEyTLMECVIFGE65BGezszDtSdJCz2OpaiBEazDFV9FGnhfdbiBYepchGez1udYM0cpUs+98jp6BJDe+sgUIgPZR0Upi0xrc3xyLQAjIoGuZCgSWYgxJqlAGHQBAgAEAhy9Y5GqbRX4AAAAASUVORK5CYII=) 注意!!! 事务控制对象 所有增删改操作都需要放入ObjectCollection对象,并且在最终使用 commit() 方法提交事务进行对数据库数据的增删改。,否则所有修改无法写入数据库

```java
ResultInfo<IObject> commit = objectCollection.commit();
```